#!/usr/bin/env ruby
# frozen_string_literal: true

# Generates team SCSS stylesheets from teams.yml without requiring Rails.
# Used during Docker build before asset precompilation.
#
# Usage: bin/generate-team-styles

require 'yaml'
require 'fileutils'

TEAMS_YAML = File.expand_path('../db/seeds/teams.yml', __dir__)
STYLESHEETS_DIR = File.expand_path('../app/assets/stylesheets/teams', __dir__)
INDEX_FILE = File.expand_path('../app/assets/stylesheets/teams.scss', __dir__)

def slugify(str)
  str.to_s
    .encode('ASCII', 'UTF-8', invalid: :replace, undef: :replace, replace: '')
    .downcase
    .gsub(/[^a-z0-9]+/, '-')
    .gsub(/-+$/, '')
end

def scss_slug(team_key, team_data)
  abbr = team_data['abbr']
  location = team_data['display_location'] || team_data['location']
  name = team_data['name']
  [abbr, location, name].compact.map { |s| slugify(s) }.join('-')
end

def color_variable_name(scss_prefix, color_name)
  color_slug = slugify(color_name)
  "#{scss_prefix}-#{color_slug}"
end

def style_class_name(scss_prefix, style_name)
  style_slug = slugify(style_name)
  "#{scss_prefix}-#{style_slug}"
end

def add_important_to_css(css)
  css.to_s.gsub(/\b(background-color|color):\s*([^;]+);/) do |match|
    prop, value = $1, $2.strip
    if value.end_with?('!important')
      match
    else
      "#{prop}: #{value} !important;"
    end
  end
end

def generate_stylesheet(team_key, team_data)
  scss_prefix = scss_slug(team_key, team_data)
  display_name = "#{team_data['display_location'] || team_data['location']} #{team_data['name']}"

  content = []
  content << "// Team: #{display_name}"
  content << "// Generated: #{Time.now.utc.iso8601}"
  content << "// Do not edit directly - regenerate via bin/generate-team-styles"
  content << ""

  # Color variables
  colors = team_data['colors'] || {}
  if colors.any?
    content << "// Color Variables"
    colors.each do |color_slug, color_data|
      var_name = color_variable_name(scss_prefix, color_data['name'])
      content << "$#{var_name}: ##{color_data['hex']};"
    end
    content << ""
  end

  # Style classes
  styles = team_data['styles'] || {}
  if styles.any?
    content << "// Style Classes"
    styles.each do |style_slug, style_data|
      class_name = style_class_name(scss_prefix, style_data['name'])
      content << ".#{class_name} {"
      content << "  #{add_important_to_css(style_data['css'])}"
      content << "}"
      content << ""
    end

    # Default style alias
    default_style = styles.find { |_, data| data['default'] }
    if default_style
      style_slug, style_data = default_style
      default_class = "#{scss_prefix}-default"
      source_class = style_class_name(scss_prefix, style_data['name'])
      content << "// Default Style Alias"
      content << ".#{default_class} {"
      content << "  @extend .#{source_class};"
      content << "}"
      content << ""
    end
  end

  content.join("\n")
end

def main
  unless File.exist?(TEAMS_YAML)
    puts "Error: #{TEAMS_YAML} not found"
    exit 1
  end

  FileUtils.mkdir_p(STYLESHEETS_DIR)

  teams = YAML.load_file(TEAMS_YAML)
  slugs = []

  teams.each do |team_key, team_data|
    slug = scss_slug(team_key, team_data)
    slugs << slug

    stylesheet_path = File.join(STYLESHEETS_DIR, "_#{slug}.scss")
    content = generate_stylesheet(team_key, team_data)
    File.write(stylesheet_path, content)
    print "."
  end

  # Generate index file
  index_content = []
  index_content << "// Team Stylesheets - Auto-generated index"
  index_content << "// Do not edit directly - regenerated by bin/generate-team-styles"
  index_content << "// Last generated: #{Time.now.utc.iso8601}"
  index_content << ""

  slugs.sort.each do |slug|
    index_content << "@import 'teams/#{slug}';"
  end

  File.write(INDEX_FILE, index_content.join("\n") + "\n")

  puts "\nGenerated #{slugs.count} team stylesheets"
  puts "Index written to #{INDEX_FILE}"
end

main
