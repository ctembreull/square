#!/bin/bash
#
# Setup secrets for the Family Squares app
#
# Usage:
#   bin/setup-secrets                    # Interactive - prompts for source
#   bin/setup-secrets /path/to/bundle    # Extract from specific file
#   bin/setup-secrets --export /path     # Create bundle for sharing
#
# The secrets bundle contains:
#   - config/master.key (Rails encryption key)
#   - .env (environment variables)
#   - db/seeds/players.yml (player data, if exists)

set -e

BUNDLE_NAME="squares-secrets.tar.gz"
DEFAULT_NAS_PATH="${SQUARES_SECRETS_PATH:-}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}!${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }

# Change to project root
cd "$(dirname "$0")/.."

export_bundle() {
  local dest="$1"
  local files=""

  # Check which files exist
  [ -f "config/master.key" ] && files="$files config/master.key"
  [ -f ".env" ] && files="$files .env"
  [ -f "db/seeds/players.yml" ] && files="$files db/seeds/players.yml"

  if [ -z "$files" ]; then
    error "No secrets files found to export"
  fi

  echo "Creating secrets bundle..."
  tar czf "$dest/$BUNDLE_NAME" $files
  info "Bundle created: $dest/$BUNDLE_NAME"
  echo ""
  echo "Files included:"
  tar tzf "$dest/$BUNDLE_NAME" | sed 's/^/  /'
}

import_bundle() {
  local src="$1"

  if [ ! -f "$src" ]; then
    error "Bundle not found: $src"
  fi

  echo "Extracting secrets bundle..."
  tar xzf "$src"

  echo ""
  info "Secrets installed:"
  [ -f "config/master.key" ] && info "  config/master.key"
  [ -f ".env" ] && info "  .env"
  [ -f "db/seeds/players.yml" ] && info "  db/seeds/players.yml"

  echo ""
  warn "Remember: These files are git-ignored and should never be committed"
}

check_status() {
  echo "Current secrets status:"
  echo ""

  if [ -f "config/master.key" ]; then
    info "config/master.key exists"
  else
    warn "config/master.key MISSING - Rails encryption won't work"
  fi

  if [ -f ".env" ]; then
    info ".env exists"
  else
    warn ".env MISSING - Docker admin user won't be created"
  fi

  if [ -f "db/seeds/players.yml" ]; then
    info "db/seeds/players.yml exists"
  else
    warn "db/seeds/players.yml MISSING - Player import will be skipped"
  fi
}

# Handle --export flag
if [ "$1" = "--export" ]; then
  if [ -z "$2" ]; then
    error "Usage: bin/setup-secrets --export /path/to/destination"
  fi
  export_bundle "$2"
  exit 0
fi

# Handle --status flag
if [ "$1" = "--status" ]; then
  check_status
  exit 0
fi

# If a path is provided, use it directly
if [ -n "$1" ]; then
  import_bundle "$1"
  exit 0
fi

# Interactive mode
echo "Family Squares - Secrets Setup"
echo "=============================="
echo ""

check_status
echo ""

# Check for default NAS path from environment
if [ -n "$DEFAULT_NAS_PATH" ] && [ -f "$DEFAULT_NAS_PATH/$BUNDLE_NAME" ]; then
  echo "Found secrets bundle at: $DEFAULT_NAS_PATH/$BUNDLE_NAME"
  read -p "Import from this location? [Y/n] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    import_bundle "$DEFAULT_NAS_PATH/$BUNDLE_NAME"
    exit 0
  fi
fi

echo ""
echo "Options:"
echo "  1) Enter path to secrets bundle"
echo "  2) Check status only"
echo "  3) Exit"
echo ""
read -p "Choice [1-3]: " choice

case $choice in
  1)
    read -p "Path to bundle: " bundle_path
    import_bundle "$bundle_path"
    ;;
  2)
    # Already showed status above
    ;;
  3|*)
    echo "Exiting."
    ;;
esac
